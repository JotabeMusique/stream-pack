import"../B5Qt9EMX.js";import{p as E,r as w,a as f,s as S,b as c,c as g,d as C,f as R}from"../C8XlNYBx.js";import{g as L,a as u,i as F,f as m,b as N,c as d,s as i,d as P}from"../ChUo-eeL.js";import{L as x}from"../B6qJfXvl.js";import{A,S as D,E as B}from"../ww_V6aJW.js";import"../DsqdWQfm.js";let a,l,n=null;async function _(){const{clientId:t,accessToken:e}=L(),s=new D(t,e);a=new A({authProvider:s}),l=new B({apiClient:a}),n=(await a.getTokenInfo()).userId,l.start()}async function k(){if(!n)return[];const t=await a.callApi({type:"helix",url:"/guest_star/session",query:{broadcaster_id:n,moderator_id:n}});if(!t?.data?.length)return[];const e=t.data[0].guests.map(o=>o.user_id).filter(o=>o!==n);return(await a.users.getUsersByIds(e)).map(o=>({id:o.id,name:o.name,displayName:o.displayName,profilePictureUrl:o.profilePictureUrl}))}async function U(){return n?(await a.channels.getChannelInfoById(n))?.title:void 0}async function O(){if(!n)return;const t=await a.channels.getChannelFollowers(n,void 0,{limit:1}),e=t.total,s=t.data.length?t.data[0].userDisplayName:null;return{followersCount:e,lastFollower:s}}async function G(){if(!n)return;const e=await(await a.subscriptions.getSubscriptionsPaginated(n)).getAll(),s=e.length,o=e.length?e[e.length-2].userDisplayName:null;return{subscriptionsCount:s,lastSubscription:o}}async function M(){return n?(await a.streams.getStreamByUserId(n))?.viewers:void 0}async function V(){if(!n)return;const t=JSON.parse(window.localStorage.getItem(x+"streamTitles")??"[]");if(!t||!t.length)return;const e=u().streamTitle,s=t.findIndex(o=>F(m(o),e));if(t[s+1]){const o=m(t[s+1]);return await a.channels.updateChannelInfo(n,{title:o})}else throw new Error("NO TITLE")}function j(t){n&&l.onChannelFollow(n,n,t)}function $(t){n&&l.onChannelSubscription(n,t)}function q(t){n&&l.onChannelSubscriptionGift(n,t)}function H(t){n&&l.onChannelSubscriptionMessage(n,t)}function J(t){n&&l.onChannelUpdate(n,t)}function r(t,e=!1){const s=document.getElementById("log");s.innerHTML=t,e?s.classList.add("isError"):s.classList.remove("isError")}function T(){const t=u();t.streamTitle&&S(t.streamTitle,{skipTransition:!0}),t.lastFollower&&c("lastFollower",t.lastFollower,void 0,!0),t.lastSubscription&&c("lastSubscriber",t.lastSubscription,void 0,!0),g("viewers","?"),t.guests&&C(t.guests)}async function Q(){const t=await U();i("streamTitle",t);const e=await O();e&&(i("lastFollower",e.lastFollower),i("followersCount",e.followersCount));const s=await G();s&&(i("lastSubscription",s.lastSubscription),i("subscriptionsCount",s.subscriptionsCount)),T()}async function W(){const t=await k();i("guests",t),C(t)}async function p(){try{const t=await M();g("viewers",t?.toString()??"?")}catch{g("viewers","?")}}function X(t){const e=t.streamTitle;i("streamTitle",e),S(e,{beforePresentation:y,afterPresentation:I}),r("Stream Title changed")}function z(t){const{followersCount:e}=u(),s=t.userDisplayName;i("lastFollower",s),i("followersCount",e+1),c("lastFollower",s),r("New Follower: "+s)}function K(t){const{subscriptionsCount:e}=u(),s=t.userDisplayName;i("lastSubscription",s),i("subscriptionsCount",e+1),c("lastSubscriber",s),r("New Subscriber: "+s)}function Y(t){r("New Sub Gifts: "+t.gifterDisplayName+" ("+t.amount+")")}function Z(t){r("New Sub Message: "+t.userDisplayName+": "+t.messageText)}function y(){const t=d();window.obsstudio&&t.autoRecording&&(window.obsstudio.stopRecording(),r("Recording stopped"))}function I(){const t=d();window.obsstudio&&t.autoRecording&&(window.obsstudio.startRecording(),r("Recording started"))}function b(){R({forcePresentation:!0,beforePresentation:y,afterPresentation:I})}function v(){const t=d(),e=document.getElementById("toggle_auto_recording");t.autoRecording?(e.classList.add("active"),e.textContent="AUTO RECORD: ACTIVE"):(e.classList.remove("active"),e.textContent="AUTO RECORD: INACTIVE")}function tt(){const t=d();P("autoRecording",!t.autoRecording),v()}async function h(){try{await V(),r("Refreshing title...")}catch(t){r("Failed to execute next title: "+t.message,!0)}}document.addEventListener("DOMContentLoaded",async()=>{N(),v(),E(),w(),T(),document.body.classList.add("--ready"),setInterval(w,1e3),setInterval(p,6e4),setInterval(W,6e4),setInterval(f,3e4);try{await _(),await Q(),await p(),J(X),j(z),$(K),q(Y),H(Z)}catch(t){console.error(t)}document.getElementById("force_presentation")?.addEventListener("click",b),document.getElementById("socials")?.addEventListener("click",f),document.getElementById("next_title")?.addEventListener("click",h),document.getElementById("toggle_auto_recording")?.addEventListener("click",tt),window.obsstudio&&(window.addEventListener("jotabe:forcePresentation",b),window.addEventListener("jotabe:nextSocial",f),window.addEventListener("jotabe:nextTitle",h))});
